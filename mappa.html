<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TLC - Protezione Civile Toscolano Maderno</title>

    <!-- CSS di Leaflet (Protocollo HTTPS esplicito) -->
    <link rel="stylesheet" href="unpkg.com" crossorigin="anonymous" />
    
    <style>
        /* Struttura bloccata per evitare errori di rendering su GitHub */
        html, body { 
            height: 100%; 
            margin: 0; 
            padding: 0;
            display: flex; 
            flex-direction: column; 
            font-family: Arial, sans-serif;
        }

        .pc-header {
            background-color: #003399; 
            color: #ffffff; 
            padding: 15px;
            border-bottom: 4px solid #ffcc00;
            text-align: center;
            flex-shrink: 0;
        }

        .controls {
            background: #ffffff;
            padding: 10px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
            border-bottom: 1px solid #ccc;
            flex-shrink: 0;
        }

        input { padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
        button { padding: 8px 15px; cursor: pointer; border-radius: 4px; border: none; font-weight: bold; color: white; }
        .btn-gps { background-color: #ffcc00; color: #003399; }
        .btn-add { background-color: #003399; }

        /* Altezza forzata della mappa */
        #map { 
            flex: 1 1 auto; /* Occupa tutto lo spazio disponibile */
            width: 100%; 
            min-height: 500px; /* Altezza minima garantita */
            background-color: #e5e3df; 
        }

        .pc-footer {
            background-color: #003399; 
            color: white; 
            padding: 10px;
            border-top: 2px solid #ffcc00;
            text-align: center;
            font-size: 0.8rem;
            flex-shrink: 0;
        }

        /* Forza la visibilit√† delle icone Leaflet */
        .leaflet-container { height: 100%; width: 100%; }
    </style>
</head>
<body>

    <header class="pc-header">
        <strong>PROTEZIONE CIVILE TOSCOLANO MADERNO - REPARTO TLC</strong>
    </header>

    <div class="controls">
        <input type="text" id="nomePunto" placeholder="ID Radio">
        <input type="number" id="lat" placeholder="Latitudine" step="any">
        <input type="number" id="lng" placeholder="Longitudine" step="any">
        <button class="btn-gps" onclick="rilevaPosizione()">üìç GPS</button>
        <button class="btn-add" onclick="aggiungiPunto()">AGGIUNGI</button>
    </div>

    <div id="map"></div>

    <footer class="pc-footer">
        Versione 2025 | Creatore: Matteo Podavini &reg;
    </footer>

    <!-- JS di Leaflet (HTTPS esplicito) -->
    <script src="unpkg.com" crossorigin="anonymous"></script>

    <script>
        // Inizializzazione sicura
        var map = L.map('map', {
            zoomControl: true 
        }).setView([45.6415, 10.6083], 13);

        // Uso di TileLayer HTTPS (Standard OSM)
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '¬© OpenStreetMap'
        }).addTo(map);

        // Fix per GitHub Pages: forza il ridisegno dopo il caricamento
        function fixMap() {
            window.dispatchEvent(new Event('resize'));
            map.invalidateSize();
        }

        window.onload = function() {
            setTimeout(fixMap, 500);
        };

        function rilevaPosizione() {
            if (!navigator.geolocation) { alert("GPS non supportato"); return; }
            navigator.geolocation.getCurrentPosition(function(pos) {
                var lt = pos.coords.latitude.toFixed(6);
                var lg = pos.coords.longitude.toFixed(6);
                document.getElementById('lat').value = lt;
                document.getElementById('lng').value = lg;
                map.setView([lt, lg], 16);
                L.marker([lt, lg]).addTo(map).bindPopup("Posizione Unit√†").openPopup();
            }, function(err) { alert("Attivare il GPS sul dispositivo"); });
        }

        function aggiungiPunto() {
            var n = document.getElementById('nomePunto').value || "Punto TLC";
            var la = parseFloat(document.getElementById('lat').value);
            var lo = parseFloat(document.getElementById('lng').value);
            if (!isNaN(la) && !isNaN(lo)) {
                L.marker([la, lo]).addTo(map).bindPopup(n).openPopup();
                map.flyTo([la, lo], 15);
            } else {
                alert("Inserire coordinate.");
            }
        }
    </script>
</body>
</html>
