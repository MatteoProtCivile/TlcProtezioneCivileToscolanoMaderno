<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Protezione Civile TLC - Toscolano Maderno</title>
    
    <!-- CSS di Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <!-- CSS righello (Leaflet.PolylineMeasure) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.polylinemeasure@3.0.0/Leaflet.PolylineMeasure.css" />
    
    <style>
        body { font-family: sans-serif; margin: 0; padding: 0; background-color: #f0f0f0; }
        .pc-header { background-color: #003399; color: #ffffff; padding: 15px; text-align: center; border-bottom: 5px solid #ffcc00; }
        .controls { background: #ffffff; padding: 10px 15px; border-bottom: 1px solid #ccc; position: relative; z-index: 1000; }
        .controls-top { text-align: center; margin-bottom: 8px; }
        .controls-filters { font-size: 0.9em; text-align: center; }
        .controls-filters label { margin: 0 5px; white-space: nowrap; }
        input, select { margin: 5px; padding: 6px 8px; border: 1px solid #ccc; border-radius: 4px; }
        button { padding: 6px 12px; cursor: pointer; background: #003399; color: white; border: none; border-radius: 4px; font-weight: bold; margin: 5px; }
        .btn-gps { background: #ffcc00; color: #003399; }
        .btn-delete { background: #cc0000; }
        .btn-excel { background: #28a745; }
        #map { height: 600px; width: 100%; border-bottom: 1px solid #ccc; }
        .pc-footer { background-color: #003399; color: white; text-align: center; padding: 10px; font-size: 0.8em; border-top: 3px solid #ffcc00; }
        
        .legend { background: white; padding: 12px; line-height: 20px; color: #333; border: 2px solid #003399; border-radius: 5px; box-shadow: 0 0 10px rgba(0,0,0,0.2); }
        .legend b { display: block; margin-bottom: 5px; border-bottom: 1px solid #ccc; }
        .legend i { width: 16px; height: 16px; float: left; margin-right: 10px; opacity: 1; border-radius: 50%; border: 1px solid #333; }
    </style>
</head>
<body>

    <div class="pc-header">
        <h2 style="margin:0;">PROTEZIONE CIVILE TOSCOLANO MADERNO</h2>
        <span style="font-size: 0.9em;">REPARTO TLC - OPERATIVO 2025</span>
    </div>

    <div class="controls">
        <div class="controls-top">
            <input type="text" id="poiName" placeholder="ID Radio / Unit√†">
            <input type="text" id="lat" placeholder="Latitudine" style="width:110px;">
            <input type="text" id="lng" placeholder="Longitudine" style="width:110px;">
            
            <select id="poiColor">
                <option value="blue">Standard (Blu)</option>
                <option value="red">Emergenza (Rosso)</option>
                <option value="green">Sanit√† (Verde)</option>
                <option value="orange">Logistica (Arancio)</option>
                <option value="yellow">Coordinamento (Oro)</option>
            </select>
            
            <br>
            <button class="btn-gps" onclick="rilevaPosizione()">üìç GPS</button>
            <button onclick="aggiungiPunto()">AGGIUNGI PUNTO</button>
            <button class="btn-excel" onclick="esportaExcel()">üì• EXCEL</button>
            <button class="btn-delete" onclick="svuotaMappa()">üóëÔ∏è RESET</button>
        </div>

        <!-- FILTRI PER TIPO DI UNIT√Ä -->
        <div class="controls-filters">
            <strong>Filtra unit√†:</strong>
            <label><input type="checkbox" class="filter-checkbox" data-color="blue" checked> Standard</label>
            <label><input type="checkbox" class="filter-checkbox" data-color="red" checked> Emergenza</label>
            <label><input type="checkbox" class="filter-checkbox" data-color="green" checked> Sanit√†</label>
            <label><input type="checkbox" class="filter-checkbox" data-color="orange" checked> Logistica</label>
            <label><input type="checkbox" class="filter-checkbox" data-color="yellow" checked> Coordinamento</label>
        </div>
    </div>

    <div id="map"></div>

    <div class="pc-footer">
        Versione 2025.1 | Creatore: Matteo Podavini &reg; | Sistema di monitoraggio TLC
    </div>

    <!-- Script Librerie -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.polylinemeasure@3.0.0/Leaflet.PolylineMeasure.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    
    <script>
        // Inizializzazione mappa
        var map = L.map('map').setView([45.6415, 10.6083], 13);

        // Layer di base: strade (OSM) e satellite (Esri)
        var streets = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        });

        var satellite = L.tileLayer(
            'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: 'Tiles &copy; Esri'
        });

        // Di default: strade
        streets.addTo(map);

        // LayerGroup per colore (per il filtro)
        var layersByColor = {
            blue:   L.layerGroup().addTo(map),
            red:    L.layerGroup().addTo(map),
            green:  L.layerGroup().addTo(map),
            orange: L.layerGroup().addTo(map),
            yellow: L.layerGroup().addTo(map)
        };

        var salvataggioPOI = JSON.parse(localStorage.getItem('poi_data')) || [];

        // Controllo per cambiare base map (in alto a destra)
        var baseMaps = {
            "Strade": streets,
            "Satellite": satellite
        };
        L.control.layers(baseMaps, null, { position: 'topright' }).addTo(map);

        // Righello (anche se ora non lo vedi, resta configurato)
        L.control.polylineMeasure({
            position: 'topleft',
            unit: 'metres',
            showBearings: true,
            clearControlTitle: 'Cancella misurazioni',
            measureControlLabel: 'MIS',
            measureControlTitleOn: 'Attiva misurazione distanze',
            measureControlTitleOff: 'Disattiva misurazione distanze'
        }).addTo(map);

        // Icone colorate
        function getIcon(color) {
            return new L.Icon({
                iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-' + color + '.png',
                shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
                iconSize: [25, 41],
                iconAnchor: [12, 41],
                popupAnchor: [1, -34],
                shadowSize: [41, 41]
            });
        }

        // Renderizza tutti i POI salvati
        window.onload = function() {
            salvataggioPOI.forEach(poi => renderizzaMarker(poi));
            setTimeout(function(){ map.invalidateSize(); }, 500);
            inizializzaFiltri();
        };

        function renderizzaMarker(poi) {
            var color = poi.color || 'blue';
            var layerGroup = layersByColor[color] || layersByColor.blue;

            var marker = L.marker([poi.lat, poi.lng], {icon: getIcon(color)})
                .bindPopup('<b>' + poi.nome + '</b><br>Lat: ' + poi.lat + '<br>Lng: ' + poi.lng + '<br>Tipo: ' + color);

            marker.addTo(layerGroup);
        }

        function rilevaPosizione() {
            if (!navigator.geolocation) return alert("GPS non supportato.");
            navigator.geolocation.getCurrentPosition(function(position) {
                document.getElementById('lat').value = position.coords.latitude.toFixed(6);
                document.getElementById('lng').value = position.coords.longitude.toFixed(6);
                map.setView([position.coords.latitude, position.coords.longitude], 15);
            });
        }

        function aggiungiPunto() {
            var lat = parseFloat(document.getElementById('lat').value);
            var lng = parseFloat(document.getElementById('lng').value);
            var nome = document.getElementById('poiName').value || "Unit√† TLC";
            var colore = document.getElementById('poiColor').value;

            if (lat && lng) {
                var nuovoPOI = { lat: lat, lng: lng, nome: nome, color: colore, data: new Date().toLocaleString() };
                salvataggioPOI.push(nuovoPOI);
                localStorage.setItem('poi_data', JSON.stringify(salvataggioPOI));
                renderizzaMarker(nuovoPOI);
                map.setView([lat, lng], 15);
            } else {
                alert("Inserisci coordinate valide.");
            }
        }

        function svuotaMappa() {
            if(confirm("Cancellare tutti i punti?")) {
                localStorage.removeItem('poi_data');
                salvataggioPOI = [];
                Object.keys(layersByColor).forEach(function(color) {
                    layersByColor[color].clearLayers();
                });
            }
        }

        function esportaExcel() {
            if(salvataggioPOI.length === 0) return alert("Nessun dato.");
            var worksheet = XLSX.utils.json_to_sheet(salvataggioPOI);
            var workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "POI_TLC");
            XLSX.writeFile(workbook, "Mappa_TLC.xlsx");
        }

        // Gestione filtri
        function inizializzaFiltri() {
            var checkboxes = document.querySelectorAll('.filter-checkbox');
            checkboxes.forEach(function(cb) {
                cb.addEventListener('change', function() {
                    var color = this.getAttribute('data-color');
                    if (this.checked) {
                        layersByColor[color].addTo(map);
                    } else {
                        map.removeLayer(layersByColor[color]);
                    }
                });
            });
        }

        // Legenda dei POI
        var legend = L.control({position: 'bottomright'});
        legend.onAdd = function (map) {
            var div = L.DomUtil.create('div', 'legend');
            div.innerHTML += '<b>LEGENDA UNIT√Ä</b><br>';
            div.innerHTML += '<i style="background: #2a82cb"></i> Standard<br>';
            div.innerHTML += '<i style="background: #cb2b3e"></i> Emergenza<br>';
            div.innerHTML += '<i style="background: #2aad27"></i> Sanit√†<br>';
            div.innerHTML += '<i style="background: #cb832b"></i> Logistica<br>';
            div.innerHTML += '<i style="background: #ffc107"></i> Coordinamento<br>';
            return div;
        };
        legend.addTo(map);
    </script>
</body>
</html>
