<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Protezione Civile TLC - Toscolano Maderno</title>
    
    <!-- CSS di Leaflet -->
    <link rel="stylesheet" href="unpkg.com" />
    <!-- CSS righello -->
    <link rel="stylesheet" href="unpkg.com" />
    
    <style>
        body { font-family: sans-serif; margin: 0; padding: 0; background-color: #f0f0f0; }
        .pc-header { background-color: #003399; color: #ffffff; padding: 15px; text-align: center; border-bottom: 5px solid #ffcc00; }
        .controls { background: #ffffff; padding: 10px 15px; border-bottom: 1px solid #ccc; position: relative; z-index: 1000; }
        .controls-top { text-align: center; margin-bottom: 8px; }
        input, select { margin: 5px; padding: 6px 8px; border: 1px solid #ccc; border-radius: 4px; }
        button { padding: 6px 12px; cursor: pointer; background: #003399; color: white; border: none; border-radius: 4px; font-weight: bold; margin: 5px; }
        .btn-gps { background: #ffcc00; color: #003399; }
        .btn-delete { background: #cc0000; }
        .btn-excel { background: #28a745; }
        #map { height: 600px; width: 100%; border-bottom: 1px solid #ccc; }
        .pc-footer { background-color: #003399; color: white; text-align: center; padding: 10px; font-size: 0.8em; border-top: 3px solid #ffcc00; }
        .legend { background: white; padding: 12px; line-height: 20px; border: 2px solid #003399; border-radius: 5px; }
        .legend i { width: 16px; height: 16px; float: left; margin-right: 10px; border-radius: 50%; border: 1px solid #333; }
    </style>
</head>
<body>

    <div class="pc-header">
        <h2 style="margin:0;">PROTEZIONE CIVILE TOSCOLANO MADERNO</h2>
        <span style="font-size: 0.9em;">REPARTO TLC - OPERATIVO 2025</span>
    </div>

    <div class="controls">
        <div class="controls-top">
            <input type="text" id="poiName" placeholder="ID Radio / Unit√†">
            <input type="text" id="lat" placeholder="Latitudine" style="width:110px;">
            <input type="text" id="lng" placeholder="Longitudine" style="width:110px;">
            
            <select id="poiColor">
                <option value="blue">Standard (Blu)</option>
                <option value="red">Emergenza (Rosso)</option>
                <option value="green">Sanit√† (Verde)</option>
                <option value="orange">Logistica (Arancio)</option>
                <option value="yellow">Coordinamento (Oro)</option>
            </select>
            
            <br>
            <button class="btn-gps" onclick="rilevaPosizione()">üìç GPS</button>
            <button onclick="aggiungiPunto()">AGGIUNGI PUNTO</button>
            <button class="btn-excel" onclick="esportaExcel()">üì• EXCEL</button>
            <button class="btn-delete" onclick="svuotaMappa()">üóëÔ∏è RESET</button>
        </div>

        <div class="controls-filters" style="text-align:center; font-size:0.9em;">
            <strong>Filtra unit√†:</strong>
            <label><input type="checkbox" class="filter-checkbox" data-color="blue" checked> Standard</label>
            <label><input type="checkbox" class="filter-checkbox" data-color="red" checked> Emergenza</label>
            <label><input type="checkbox" class="filter-checkbox" data-color="green" checked> Sanit√†</label>
            <label><input type="checkbox" class="filter-checkbox" data-color="orange" checked> Logistica</label>
            <label><input type="checkbox" class="filter-checkbox" data-color="yellow" checked> Coordinamento</label>
        </div>
    </div>

    <div id="map"></div>

    <div class="pc-footer">
        Versione 2025.1 | Creatore: Matteo Podavini &reg; | Sistema di monitoraggio TLC
    </div>

    <!-- Script Librerie -->
    <script src="unpkg.com"></script>
    <script src="unpkg.com"></script>
    <script src="cdn.jsdelivr.net"></script>
    
    <script>
        // 1. Inizializzazione Mappa
        var map = L.map('map').setView([45.6415, 10.6083], 13);

        // 2. Click sulla mappa per catturare coordinate (MODIFICA RICHIESTA)
        map.on('click', function(e) {
            document.getElementById('lat').value = e.latlng.lat.toFixed(6);
            document.getElementById('lng').value = e.latlng.lng.toFixed(6);
        });

        // 3. Layer Strade e Satellite
        var streets = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap'
        }).addTo(map);

        var satellite = L.tileLayer('server.arcgisonline.com{z}/{y}/{x}', {
            attribution: 'Tiles &copy; Esri'
        });

        var baseMaps = { "Strade": streets, "Satellite": satellite };
        L.control.layers(baseMaps, null, { position: 'topright' }).addTo(map);

        // 4. Righello (MODIFICA RICHIESTA - Icona forzata con emoji)
        L.control.polylineMeasure({
            position: 'topleft',
            unit: 'metres',
            measureControlLabel: 'üìè', 
            clearControlTitle: 'Cancella'
        }).addTo(map);

        // 5. Gestione Unit√† e Colori
        var layersByColor = {
            blue: L.layerGroup().addTo(map),
            red: L.layerGroup().addTo(map),
            green: L.layerGroup().addTo(map),
            orange: L.layerGroup().addTo(map),
            yellow: L.layerGroup().addTo(map)
        };

        var salvataggioPOI = JSON.parse(localStorage.getItem('poi_data')) || [];

        function getIcon(color) {
            return new L.Icon({
                iconUrl: 'raw.githubusercontent.com' + color + '.png',
                shadowUrl: 'unpkg.com',
                iconSize: [25, 41],
                iconAnchor: [12, 41],
                popupAnchor: [1, -34],
                shadowSize: [41, 41]
            });
        }

        function renderizzaMarker(poi) {
            var color = poi.color || 'blue';
            var marker = L.marker([poi.lat, poi.lng], {icon: getIcon(color)})
                .bindPopup('<b>' + poi.nome + '</b><br>Lat: ' + poi.lat + '<br>Lng: ' + poi.lng);
            marker.addTo(layersByColor[color]);
        }

        window.onload = function() {
            salvataggioPOI.forEach(poi => renderizzaMarker(poi));
            inizializzaFiltri();
        };

        function aggiungiPunto() {
            var lat = parseFloat(document.getElementById('lat').value);
            var lng = parseFloat(document.getElementById('lng').value);
            var nome = document.getElementById('poiName').value || "Unit√† TLC";
            var colore = document.getElementById('poiColor').value;

            if (lat && lng) {
                var nuovoPOI = { lat: lat, lng: lng, nome: nome, color: colore };
                salvataggioPOI.push(nuovoPOI);
                localStorage.setItem('poi_data', JSON.stringify(salvataggioPOI));
                renderizzaMarker(nuovoPOI);
            } else {
                alert("Seleziona un punto sulla mappa o usa il GPS.");
            }
        }

        function rilevaPosizione() {
            if (!navigator.geolocation) return alert("GPS non supportato.");
            navigator.geolocation.getCurrentPosition(function(position) {
                document.getElementById('lat').value = position.coords.latitude.toFixed(6);
                document.getElementById('lng').value = position.coords.longitude.toFixed(6);
                map.setView([position.coords.latitude, position.coords.longitude], 15);
            });
        }

        function esportaExcel() {
            if(salvataggioPOI.length === 0) return alert("Nessun dato.");
            var worksheet = XLSX.utils.json_to_sheet(salvataggioPOI);
            var workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "POI_TLC");
            XLSX.writeFile(workbook, "Mappa_TLC_2025.xlsx");
        }

        function svuotaMappa() {
            if(confirm("Cancellare tutti i dati?")) {
                localStorage.removeItem('poi_data');
                location.reload();
            }
        }

        function inizializzaFiltri() {
            document.querySelectorAll('.filter-checkbox').forEach(cb => {
                cb.addEventListener('change', function() {
                    var color = this.getAttribute('data-color');
                    if (this.checked) map.addLayer(layersByColor[color]);
                    else map.removeLayer(layersByColor[color]);
                });
            });
        }

        var legend = L.control({position: 'bottomright'});
        legend.onAdd = function () {
            var div = L.DomUtil.create('div', 'legend');
            div.innerHTML = '<b>LEGENDA</b><br>' +
                '<i style="background: #2a82cb"></i> Standard<br>' +
                '<i style="background: #cb2b3e"></i> Emergenza<br>' +
                '<i style="background: #2aad27"></i> Sanit√†<br>' +
                '<i style="background: #cb832b"></i> Logistica<br>' +
                '<i style="background: #ffc107"></i> Coord.';
            return div;
        };
        legend.addTo(map);
    </script>
</body>
</html>
