<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TLC Toscolano Maderno - Operativo</title>

    <!-- 1. CSS FONDAMENTALE (Senza questo la mappa √® grigia e i tasti +/- spariscono) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        body { font-family: sans-serif; margin: 0; background: #f4f4f4; }
        .header { background: #003399; color: white; padding: 15px; border-bottom: 4px solid #ffcc00; text-align: center; }
        .controls { padding: 15px; background: white; display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        
        /* 2. ALTEZZA FISSA (Essenziale per la visibilit√†) */
        #map { height: 75vh; width: 100%; background: #ddd; }

        input { padding: 8px; border: 1px solid #ccc; border-radius: 4px; width: 150px; }
        button { padding: 8px 15px; cursor: pointer; border-radius: 4px; border: none; font-weight: bold; }
        .btn-add { background: #003399; color: white; }
        .btn-gps { background: #ffcc00; color: #003399; }
    </style>
</head>
<body>

<div class="header">
    <strong>PRO-CIV TOSCOLANO MADERNO - REPARTO TLC</strong>
</div>

<div class="controls">
    <input type="text" id="poiName" placeholder="ID Radio / Unit√†">
    <input type="number" id="lat" placeholder="Latitudine" step="any">
    <input type="number" id="lng" placeholder="Longitudine" step="any">
    <button class="btn-gps" onclick="rilevaPosizione()">üìç RILEVA GPS</button>
    <button class="btn-add" onclick="aggiungiPunto()">AGGIUNGI PUNTO</button>
</div>

<div id="map"></div>

<!-- 3. JS DI LEAFLET -->
<script src="unpkg.com"></script>

<script>
    // Inizializzazione Mappa
    var map = L.map('map', {
        center: [45.6415, 10.6083],
        zoom: 13,
        zoomControl: true // Forza la visualizzazione dei tasti + e -
    });

    // Tile Layer standard (OpenStreetMap)
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // Funzione GPS
    function rilevaPosizione() {
        if (!navigator.geolocation) {
            alert("Il tuo browser non supporta il GPS.");
            return;
        }
        navigator.geolocation.getCurrentPosition(function(pos) {
            document.getElementById('lat').value = pos.coords.latitude.toFixed(6);
            document.getElementById('lng').value = pos.coords.longitude.toFixed(6);
            map.setView([pos.coords.latitude, pos.coords.longitude], 16);
        }, function(err) {
            alert("Errore GPS: " + err.message);
        });
    }

    // Funzione Aggiungi Punto (Corretta)
    function aggiungiPunto() {
        var latVal = document.getElementById('lat').value;
        var lngVal = document.getElementById('lng').value;
        var nome = document.getElementById('poiName').value || "Unit√† TLC";

        if (latVal === "" || lngVal === "") {
            alert("Inserisci coordinate o usa il tasto GPS");
            return;
        }

        var lat = parseFloat(latVal);
        var lng = parseFloat(lngVal);

        // Controllo validit√† numerica
        if (!isNaN(lat) && !isNaN(lng)) {
            var marker = L.marker([lat, lng]).addTo(map);
            marker.bindPopup("<b>" + nome + "</b><br>Lat: " + lat + "<br>Lng: " + lng).openPopup();
            map.panTo([lat, lng]); // Sposta la vista sul punto senza cambiare zoom
        } else {
            alert("Coordinate non valide.");
        }
    }

    // Risolve il bug della mappa grigia forzando il ridisegno all'avvio
    window.onload = function() {
        setTimeout(function(){ map.invalidateSize(); }, 400);
    };
</script>

</body>
</html>
