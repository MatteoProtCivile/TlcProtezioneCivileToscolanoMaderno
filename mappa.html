<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TLC - Protezione Civile Toscolano Maderno</title>

    <!-- FONDAMENTALE: CSS di Leaflet con integrit√† verificata -->
    <link rel="stylesheet" href="unpkg.com" crossorigin="" />
    
    <style>
        /* Struttura Pagina */
        html, body { 
            height: 100%; 
            margin: 0; 
            display: flex; 
            flex-direction: column; 
            font-family: sans-serif;
            background-color: #ffffff;
        }

        /* Header */
        .pc-header {
            background-color: #003399; 
            color: white; 
            padding: 15px;
            border-bottom: 4px solid #ffcc00;
            text-align: center;
        }

        /* Area Controlli */
        .controls {
            background: #f8f9fa;
            padding: 10px;
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            justify-content: center;
            border-bottom: 1px solid #ddd;
        }

        input { padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
        
        button { 
            padding: 8px 15px; 
            cursor: pointer; 
            border-radius: 4px; 
            border: none; 
            font-weight: bold; 
        }

        .btn-gps { background-color: #ffcc00; color: #003399; }
        .btn-add { background-color: #003399; color: white; }

        /* Mappa: Forzata la visibilit√† con altezza minima */
        #map { 
            flex-grow: 1; 
            width: 100%; 
            min-height: 400px;
            background: #e0e0e0; /* Colore di backup se la mappa non carica */
        }

        /* Footer */
        .pc-footer {
            background-color: #003399; 
            color: white; 
            padding: 10px;
            border-top: 2px solid #ffcc00;
            text-align: center;
            font-size: 0.8rem;
        }

        /* Stile forzato per pulsanti zoom se spariscono */
        .leaflet-control-zoom {
            border: 2px solid #003399 !important;
        }
    </style>
</head>
<body>

    <header class="pc-header">
        <strong>PROTEZIONE CIVILE TOSCOLANO MADERNO - REPARTO TLC</strong>
    </header>

    <div class="controls">
        <input type="text" id="nomePunto" placeholder="ID Radio">
        <input type="number" id="lat" placeholder="Latitudine" step="any">
        <input type="number" id="lng" placeholder="Longitudine" step="any">
        <button class="btn-gps" onclick="rilevaPosizione()">üìç GPS</button>
        <button class="btn-add" onclick="aggiungiPunto()">AGGIUNGI</button>
    </div>

    <div id="map"></div>

    <footer class="pc-footer">
        Versione 2025 | Creatore: Matteo Podavini &reg;
    </footer>

    <!-- JS di Leaflet -->
    <script src="unpkg.com" crossorigin=""></script>

    <script>
        // Inizializzazione mappa
        var map = L.map('map', {
            zoomControl: true // Attiva i tasti + e -
        }).setView([45.6415, 10.6083], 13);

        // Caricamento layer stradale
        var osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '¬© OpenStreetMap'
        }).addTo(map);

        // FUNZIONE PER RISOLVERE IL PROBLEMA DELLA MAPPA INVISIBILE
        function fixMap() {
            setTimeout(function() {
                map.invalidateSize();
                console.log("Mappa ricalcolata correttamente.");
            }, 500);
        }

        // Avvia il fix al caricamento
        window.onload = fixMap;

        function rilevaPosizione() {
            if (!navigator.geolocation) { alert("GPS non supportato"); return; }
            navigator.geolocation.getCurrentPosition(function(pos) {
                var lt = pos.coords.latitude.toFixed(6);
                var lg = pos.coords.longitude.toFixed(6);
                document.getElementById('lat').value = lt;
                document.getElementById('lng').value = lg;
                map.setView([lt, lg], 16);
                L.marker([lt, lg]).addTo(map).bindPopup("Sei qui").openPopup();
            }, function(err) { alert("Errore GPS"); });
        }

        function aggiungiPunto() {
            var n = document.getElementById('nomePunto').value || "Unit√† TLC";
            var la = parseFloat(document.getElementById('lat').value);
            var lo = parseFloat(document.getElementById('lng').value);
            if (!isNaN(la) && !isNaN(lo)) {
                L.marker([la, lo]).addTo(map).bindPopup(n).openPopup();
                map.panTo([la, lo]);
            } else {
                alert("Inserire coordinate.");
            }
        }
    </script>
</body>
</html>
