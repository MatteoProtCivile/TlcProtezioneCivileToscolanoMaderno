<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Protezione Civile TLC - Toscolano Maderno</title>
    
    <!-- CSS di Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <!-- CSS righello (Leaflet.PolylineMeasure) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.polylinemeasure@3.0.0/Leaflet.PolylineMeasure.css" />
    
    <style>
        body { font-family: sans-serif; margin: 0; padding: 0; background-color: #f0f0f0; }
        .pc-header { background-color: #003399; color: #ffffff; padding: 15px; text-align: center; border-bottom: 5px solid #ffcc00; }
        .controls { background: #ffffff; padding: 10px 15px; border-bottom: 1px solid #ccc; position: relative; z-index: 1000; }
        .controls-top { text-align: center; margin-bottom: 8px; }
        .controls-filters { font-size: 0.9em; text-align: center; padding: 10px; border-top: 1px solid #eee; }
        .controls-filters label { margin: 0 10px; cursor: pointer; }
        input, select { margin: 5px; padding: 6px 8px; border: 1px solid #ccc; border-radius: 4px; }
        button { padding: 6px 12px; cursor: pointer; background: #003399; color: white; border: none; border-radius: 4px; font-weight: bold; margin: 5px; }
        .btn-gps { background: #ffcc00; color: #003399; }
        .btn-delete { background: #cc0000; }
        .btn-excel { background: #28a745; }
        .btn-save-local { background: #17a2b8; }
        #map { height: 600px; width: 100%; border-bottom: 1px solid #ccc; background: #ddd; }
        .pc-footer { background-color: #003399; color: white; text-align: center; padding: 10px; font-size: 0.8em; border-top: 3px solid #ffcc00; }
		
        .legend { background: white; padding: 10px; line-height: 18px; color: #333; border: 2px solid #003399; border-radius: 5px; }
        .legend i { width: 14px; height: 14px; float: left; margin-right: 8px; border-radius: 50%; border: 1px solid #333; }
    </style>
</head>
<body>

    <div class="pc-header">
        <h2 style="margin:0;">PROTEZIONE CIVILE TOSCOLANO MADERNO</h2>
        <span style="font-size: 0.9em;">REPARTO TLC - OPERATIVO 2026</span>
    </div>

    <div class="controls">
        <div class="controls-top">
            <input type="text" id="poiName" placeholder="ID Radio / Unit√†">
            <input type="text" id="lat" placeholder="Latitudine" style="width:110px;">
            <input type="text" id="lng" placeholder="Longitudine" style="width:110px;">
            
            <select id="poiColor">
                <optgroup label="Standard">
                    <option value="blue">Standard (Blu)</option>
                    <option value="red">Emergenza (Rosso)</option>
                    <option value="green">Sanit√† (Verde)</option>
                    <option value="orange">Logistica (Arancio)</option>
                    <option value="yellow">Coordinamento (Oro)</option>
                </optgroup>
                <optgroup label="Speciali AIB ">
                    <option value="aib-fuoco">üî• AIB - Incendio</option>
                    <option value="aib-idrante">üíß Punto Idrico</option>
                    <option value="aib-botte">üöõ Autobotte</option>
                    <option value="drone">üöÅ Unit√† Elicottero</option>
                    <option value="ponte">üì° Ponte Radio</option>
                    <option value="coc">üèõÔ∏è C.O.C. Comando</option>
					<option value="personale">üë®‚Äçüöí Personale AIB</option>
					<option value="avvistamento">üî≠ Punto di Avvistamento</option>
					<option value="DOS">üë∑ Dos</option>
                    <option value="chiusura">üö´ Blocco Stradale</option>
                    <option value="sub">üö§ Pompa Acqua</option>
                    <option value="cinofili">üêï Cinofili</option>
                    <option value="frana">‚ö†Ô∏è Monitoraggio</option>
	                </optgroup>
            </select>
            
            <br>
            <button class="btn-gps" onclick="rilevaPosizione()">üìç GPS</button>
            <button onclick="aggiungiPunto()">AGGIUNGI PUNTO</button>
            <button class="btn-excel" onclick="esportaExcel()">üì• EXCEL</button>
            <button class="btn-save-local" onclick="salvaMappaIntera()">üíæ SALVA MAPPA LOCALE</button>
            <button class="btn-delete" onclick="svuotaMappa()">üóëÔ∏è RESET</button>
        </div>

        <div class="controls-filters">
            <strong>Filtra unit√†:</strong>
            <label><input type="checkbox" class="filter-checkbox" data-color="blue" checked> Standard</label>
            <label><input type="checkbox" class="filter-checkbox" data-color="red" checked> Emergenza</label>
            <label><input type="checkbox" class="filter-checkbox" data-color="green" checked> Sanit√†</label>
            <label><input type="checkbox" class="filter-checkbox" data-color="orange" checked> Logistica</label>
            <label><input type="checkbox" class="filter-checkbox" data-color="yellow" checked> Coordinamento</label>
        </div>
    </div>

    <div id="map"></div>

    <div class="pc-footer">
        Versione 2026.1 | Creatore: Matteo Podavini &reg; | Sistema di monitoraggio TLC
    </div>

   <!-- Script Librerie -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.polylinemeasure@3.0.0/Leaflet.PolylineMeasure.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    
    
    <script>
       	
         // Inizializzazione mappa
        var map = L.map('map').setView([45.6415, 10.6083], 13);
		// Funzione per intercettare il click sulla mappa e compilare i campi coordinate
            map.on('click', function(e) {
			var lat = e.latlng.lat.toFixed(6);
			var lng = e.latlng.lng.toFixed(6);
    
    document.getElementById('lat').value = lat;
    document.getElementById('lng').value = lng;
    
    // Opzionale: un piccolo popup temporaneo che conferma la selezione
    L.popup()
        .setLatLng(e.latlng)
        .setContent("Coordinate selezionate: <br>" + lat + ", " + lng)
        .openOn(map);
});


        // Layer di base: strade (OSM) e satellite (Esri)
        var streets = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        });

        var satellite = L.tileLayer(
            'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: 'Tiles &copy; Esri'
        });

        // Di default: strade
        streets.addTo(map);

        // LayerGroup per colore (per il filtro)
        var layersByColor = {
            blue:   L.layerGroup().addTo(map),
            red:    L.layerGroup().addTo(map),
            green:  L.layerGroup().addTo(map),
            orange: L.layerGroup().addTo(map),
            yellow: L.layerGroup().addTo(map)
        };

        var salvataggioPOI = JSON.parse(localStorage.getItem('poi_data')) || [];

        // Controllo per cambiare base map (in alto a destra)
        var baseMaps = {
            "Strade": streets,
            "Satellite": satellite
        };
        L.control.layers(baseMaps, null, { position: 'topright' }).addTo(map);

        // Righello (anche se ora non lo vedi, resta configurato)
        L.control.polylineMeasure({
            position: 'topleft',
            unit: 'metres',
            showBearings: true,
            clearControlTitle: 'Cancella misurazioni',
            measureControlLabel: 'MIS',
            measureControlTitleOn: 'Attiva misurazione distanze',
            measureControlTitleOff: 'Disattiva misurazione distanze'
        }).addTo(map);

        function getIcon(tipo) {
    var iconeSpeciali = {
        'aib-fuoco': 'üî•',
        'aib-idrante': 'üíß',
        'aib-botte': 'üöõ',
        'drone': 'üöÅ',
        'ponte': 'üì°',
        'coc': 'üèõÔ∏è',
		'aib-uomo': 'üë®‚Äçüöí', 
		'punto di vista': 'üî≠'
		'aib-Dos': 'üë∑', 	
        'chiusura': 'üö´',
        'sub': 'üö§',
        'cinofili': 'üêï',
        'frana': '‚ö†Ô∏è'
	 
    };

    // Se √® un'unit√† speciale, creiamo un marker con l'Emoji
    if (iconeSpeciali[tipo]) {
        return L.divIcon({
            html: '<div style="font-size: 24px; background: white; border-radius: 50%; padding: 5px; border: 2px solid #003399; text-align: center; width: 30px; height: 30px; line-height: 30px;">' + iconeSpeciali[tipo] + '</div>',
            className: 'custom-div-icon',
            iconSize: [40, 40],
            iconAnchor: [20, 20],
            popupAnchor: [0, -20]
        });
    }

    // Per le unit√† standard, usiamo il marker colorato classico
    var col = (tipo === 'yellow') ? 'gold' : (tipo || 'blue');
    return new L.Icon({
        iconUrl: 'https://raw.githubusercontent.com' + col + '.png',
        shadowUrl: 'https://unpkg.com',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
    });
}


       function renderizzaMarker(poi) {
    var g = 'blue';
    var t = poi.color;

    if (['red', 'aib-fuoco', 'frana', 'chiusura', 'avvistamento'].includes(t)) g = 'red';
    else if (['green', 'personale-aib', 'cinofili'].includes(t)) g = 'green';
    else if (['orange','aib-botte'].includes(t)) g = 'orange';
    else if (['yellow', 'dos', 'drone', 'ponte'].includes(t)) g = 'yellow';

    L.marker([poi.lat, poi.lng], {icon: getIcon(t)})
        .bindPopup('<b>' + poi.nome + '</b>')
        .addTo(layersByColor[g]);
}


        window.onload = function() {
            salvataggioPOI.forEach(renderizzaMarker);
            document.querySelectorAll('.filter-checkbox').forEach(cb => {
                cb.addEventListener('change', function() {
                    var color = this.getAttribute('data-color');
                    this.checked ? map.addLayer(layersByColor[color]) : map.removeLayer(layersByColor[color]);
                });
            });
        };

        function aggiungiPunto() {
            var lat = parseFloat(document.getElementById('lat').value);
            var lng = parseFloat(document.getElementById('lng').value);
            if (!isNaN(lat) && !isNaN(lng)) {
                var p = {lat: lat, lng: lng, nome: document.getElementById('poiName').value || "Unit√† TLC", color: document.getElementById('poiColor').value};
                salvataggioPOI.push(p);
                localStorage.setItem('poi_data', JSON.stringify(salvataggioPOI));
                renderizzaMarker(p);
                map.setView([lat, lng], 15);
            } else { alert("Inserisci coordinate valide."); }
        }

        function rilevaPosizione() {
            navigator.geolocation.getCurrentPosition(p => {
                document.getElementById('lat').value = p.coords.latitude.toFixed(6);
                document.getElementById('lng').value = p.coords.longitude.toFixed(6);
                map.setView([p.coords.latitude, p.coords.longitude], 15);
            });
        }

        function svuotaMappa() {
            if(confirm("Cancellare tutti i punti?")) {
                localStorage.removeItem('poi_data');
                location.reload();
            }
        }

        function esportaExcel() {
            if(salvataggioPOI.length === 0) return alert("Nessun dato.");
            var ws = XLSX.utils.json_to_sheet(salvataggioPOI);
            var wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "POI_TLC");
            XLSX.writeFile(wb, "Mappa_TLC.xlsx");
        }

        function salvaMappaIntera() {
            var datiStr = "var salvataggioPOI = " + JSON.stringify(salvataggioPOI) + ";";
            var html = document.documentElement.outerHTML.replace(/var salvataggioPOI = .*?;/, datiStr);
            var a = document.createElement('a');
            a.href = URL.createObjectURL(new Blob([html], {type: 'text/html'}));
            a.download = "Mappa_TLC_Toscolano_2026.html";
            a.click();
        }

        var legend = L.control({position: 'bottomright'});
        legend.onAdd = function (map) {
            var div = L.DomUtil.create('div', 'legend');
            div.innerHTML = '<b>LEGENDA UNIT√Ä</b><br>' +
                '<i style="background: #2a82cb"></i> Standard<br>' +
                '<i style="background: #cb2b3e"></i> Emergenza/AIB<br>' +
                '<i style="background: #2aad27"></i> Sanit√†<br>' +
                '<i style="background: #cb832b"></i> Logistica<br>' +
                '<i style="background: #ffc107"></i> Coordinamento';
            return div;
        };
        legend.addTo(map);
    </script>
</body>
</html>






